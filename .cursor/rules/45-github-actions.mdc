---
alwaysApply: true
---
# GitHub Actions CI/CD 规则

## 核心约束（强制）

1. **CI/CD 流程必须完全自动化**
2. **构建和发布必须分离（构建标签 vs 发布标签）**
3. **构建号必须自动递增**
4. **更新配置文件必须自动生成**

## 两阶段发布流程

### 阶段1：构建（Build）

**触发：** 推送 `build*` 标签（如 `build1.0.7`）

**步骤：**
1. 并行构建所有平台
2. 自动递增构建号
3. 提交构建号更新
4. 上传构建产物到 artifacts

### 阶段2：发布（Release）

**触发：** 推送 `v*` 标签或手动触发

**步骤：**
1. 下载构建产物
2. 计算文件 hash
3. 生成更新配置文件
4. 创建 GitHub Release
5. 上传构建产物和配置文件

## 工作流结构

### 构建工作流（build.yml）

```yaml
name: Build All Platforms

on:
  push:
    tags:
      - 'build*'
  workflow_dispatch:

jobs:
  build-platform-1:
    # 平台1构建任务
  build-platform-2:
    # 平台2构建任务
  
  increment-build-number:
    needs: [build-platform-1, build-platform-2]
    steps:
      - name: Increment build number
        run: |
          # 从 VERSION.yaml 读取版本
          # 递增构建号
          # 提交并推送
```

### 发布工作流（release.yml）

```yaml
name: Create Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: '版本号'
        required: false

jobs:
  create-release:
    steps:
      - name: Download artifacts
        # 下载构建产物
      - name: Calculate hash
        # 计算 SHA256
      - name: Generate update config
        # 生成更新配置
      - name: Create Release
        # 创建 GitHub Release
```

## 构建产物命名

### 文件命名规则

**格式：** `{project}_{platform}_{version}build{build}.zip`

**示例：**
- `MyApp_macos_1.0.7build13.zip`
- `MyApp_windows_1.0.7build13.zip`
- `MyApp_linux_1.0.7build13.zip`

**注意：** 使用 `build` 替代 `+` 避免 URL 特殊字符问题

### ZIP 包内文件

ZIP 包内的安装文件使用固定命名（不含版本号）：
- 版本信息由 ZIP 文件名和 hash 保证
- 简化更新逻辑

## 更新配置文件

### 配置文件位置

固定的 GitHub Release（标签：`UpdateConfig`）

**URL：** `https://github.com/{owner}/{repo}/releases/download/UpdateConfig/update_config.json`

### 配置文件格式

```json
{
  "component": {
    "version": "1.0.7+13",
    "versionNumber": "1.0.7",
    "platforms": {
      "platform_name": {
        "version": "1.0.7+13",
        "downloadUrl": "https://...",
        "fileName": "...",
        "fileHash": "sha256_value"
      }
    }
  },
  "lastUpdated": "2024-01-01T12:00:00Z"
}
```

## 发布流程

### 标准流程

```bash
# 1. 更新版本号
./scripts/version.sh bump component minor

# 2. 提交代码
git add VERSION.yaml
git commit -m "Bump version to x.y.z"
git push origin main

# 3. 创建构建标签
git tag build1.0.7
git push origin build1.0.7

# 4. 等待构建完成（GitHub Actions）

# 5. 创建发布（手动触发或推送 v 标签）
git tag v1.0.7
git push origin v1.0.7
```

## 权限配置

```yaml
permissions:
  contents: write  # 创建 release 和推送代码
  actions: read    # 读取 artifacts
```

## 禁止行为

- ❌ 手动创建 GitHub Release
- ❌ 手动上传构建产物
- ❌ 手动生成更新配置文件
- ❌ 文件名使用 `+` 号
- ❌ 不计算文件 hash
- ❌ 不自动递增构建号

## 必须遵守

- ✅ 使用两阶段发布流程
- ✅ 构建标签：`build{version}`
- ✅ 发布标签：`v{version}`
- ✅ 构建号自动递增
- ✅ 自动生成更新配置文件
- ✅ 计算并包含文件 SHA256 hash
- ✅ 构建产物文件名包含版本号
