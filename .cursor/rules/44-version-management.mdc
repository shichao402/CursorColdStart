---
alwaysApply: true
---
# 版本管理规则

## 核心约束（强制）

1. **版本号必须由项目自身管理，不依赖外部平台**
2. **版本号必须使用单一数据源（VERSION.yaml）**
3. **构建号必须自动递增**
4. **版本号必须自动同步到项目配置文件**

## 版本号格式

### 语义化版本号

格式：`主版本号.次版本号.修订号+构建号`（`x.y.z+build`）

示例：`1.0.7+13`
- `1.0.7` - 版本号（主版本.次版本.修订号）
- `+13` - 构建号

### 版本号组成

| 部分 | 说明 | 递增时机 |
|------|------|----------|
| Major | 主版本号 | 不兼容的 API 更改 |
| Minor | 次版本号 | 向后兼容的新功能 |
| Patch | 修订号 | 向后兼容的 bug 修复 |
| Build | 构建号 | 每次构建自动递增 |

## 版本号存储

### 单一数据源

版本号统一存储在 `VERSION.yaml` 文件中：

```yaml
cursorcoldstart:
  version: "1.0.7+13"

compatibility:
  min_cursorcoldstart_version: "1.0.6"

update:
  github:
    url: https://github.com/owner/cursorcoldstart/releases/download/UpdateConfig/update_config.json
```

### 多组件项目

```yaml
client:
  version: "1.0.7+13"
server:
  version: "1.0.8+5"

compatibility:
  min_client_version: "1.0.6"
  min_server_version: "1.0.6"
```

## 版本管理脚本

项目必须提供版本管理脚本 `scripts/version.sh`：

```bash
# 查看版本
./scripts/version.sh get [component]

# 设置版本
./scripts/version.sh set [component] x.y.z+build

# 递增版本
./scripts/version.sh bump [component] [major|minor|patch|build]

# 同步到项目配置
./scripts/version.sh sync [component]
```

## 自动同步机制

构建脚本必须自动从 `VERSION.yaml` 同步版本号到项目配置文件。

**流程：**
```
VERSION.yaml (单一数据源)
       ↓
  构建脚本自动同步
       ↓
  项目配置文件 (pubspec.yaml / package.json / 等)
```

## 版本兼容性检查

### 检查流程

```
组件连接
    ↓
发送版本号
    ↓
检查最小版本要求
    ├─ 满足 → 允许连接
    └─ 不满足 → 拒绝并通知升级
```

## 代码中读取版本号

### 版本服务接口

```
VersionService:
  - getVersion()           // 返回完整版本 "x.y.z+build"
  - getVersionNumber()     // 返回版本号 "x.y.z"
  - getBuildNumber()       // 返回构建号
  - checkCompatibility(v)  // 检查版本兼容性
```

### 使用示例（伪代码）

```
// ✅ 正确：通过版本服务获取
version = VersionService.getVersion()
buildNumber = VersionService.getBuildNumber()

// ❌ 错误：硬编码版本号
version = "1.0.0"
```

## 禁止行为

- ❌ 手动编辑项目配置文件中的版本号
- ❌ 在代码中硬编码版本号
- ❌ 依赖 Git 标签或 CI/CD 平台管理版本号
- ❌ 构建脚本不同步版本号

## 必须遵守

- ✅ 版本号存储在 VERSION.yaml
- ✅ 提供版本管理脚本
- ✅ 构建时自动同步版本号
- ✅ 代码通过版本服务读取版本号
- ✅ 构建号自动递增
