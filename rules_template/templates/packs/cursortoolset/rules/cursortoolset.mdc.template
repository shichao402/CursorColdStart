---
alwaysApply: true
---
# CursorToolset 包开发规则

## 概述

本项目是一个 **CursorToolset 包**，遵循 CursorToolset 包开发规范进行开发、打包和发布。

## 核心约束（强制）

1. **必须使用 `cursortoolset release` 命令发布**（唯一推荐方式）
2. **必须使用 `cursortoolset pack` 命令打包**（保证版本一致性）
3. **发布包必须包含 SHA256 校验和**
4. **可执行文件必须在 `bin` 字段中声明（支持多平台）**
5. **遵循语义化版本规范**

## 目录结构规范

```
{{ PROJECT_NAME }}/
├── package.json              # 包清单文件（必需）
├── README.md                 # 说明文档
├── bin/                      # 可执行文件目录
│   ├── {{ PACKAGE_NAME }}-darwin-amd64
│   ├── {{ PACKAGE_NAME }}-darwin-arm64
│   ├── {{ PACKAGE_NAME }}-linux-amd64
│   ├── {{ PACKAGE_NAME }}-linux-arm64
│   ├── {{ PACKAGE_NAME }}-windows-amd64.exe
│   └── {{ PACKAGE_NAME }}-windows-arm64.exe
├── .github/
│   └── workflows/
│       └── release.yml       # 自动发布工作流
├── .cursortoolset/           # CursorToolset 本地配置
│   ├── rules/                # 同步的规则文件
│   └── docs/                 # 同步的文档
└── scripts/                  # 脚本文件
```

## package.json 规范

### 完整示例

```json
{
  "name": "{{ PACKAGE_NAME }}",
  "displayName": "{{ PACKAGE_DISPLAY_NAME }}",
  "version": "1.0.0",
  "description": "{{ PACKAGE_DESCRIPTION }}",
  "author": "{{ PROJECT_AUTHOR }}",
  "license": "MIT",
  "keywords": ["cursor", "ai", "toolset"],
  "repository": {
    "type": "git",
    "url": "https://github.com/username/{{ PACKAGE_NAME }}.git"
  },
  "bin": {
    "{{ PACKAGE_NAME }}": {
      "darwin-amd64": "bin/{{ PACKAGE_NAME }}-darwin-amd64",
      "darwin-arm64": "bin/{{ PACKAGE_NAME }}-darwin-arm64",
      "linux-amd64": "bin/{{ PACKAGE_NAME }}-linux-amd64",
      "linux-arm64": "bin/{{ PACKAGE_NAME }}-linux-arm64",
      "windows-amd64": "bin/{{ PACKAGE_NAME }}-windows-amd64.exe",
      "windows-arm64": "bin/{{ PACKAGE_NAME }}-windows-arm64.exe"
    }
  },
  "dist": {
    "tarball": "{{ PACKAGE_NAME }}-1.0.0.tar.gz",
    "sha256": "TODO: 发布时自动填写"
  },
  "cursortoolset": {
    "minVersion": "1.0.0"
  }
}
```

### 字段说明

| 字段 | 必需 | 说明 |
|------|------|------|
| `name` | ✅ | 包名，小写字母、数字、连字符 |
| `version` | ✅ | 语义化版本号 (MAJOR.MINOR.PATCH) |
| `description` | ✅ | 包的简要描述 |
| `dist.tarball` | ✅ | 发布包文件名（相对路径） |
| `dist.sha256` | ✅ | 发布包的 SHA256 校验和 |
| `bin` | ⚪ | 可执行文件映射（支持多平台） |
| `cursortoolset.minVersion` | ⚪ | 最低管理器版本要求 |

### 多平台 bin 配置

支持的平台标识：

| 平台 | 标识 |
|------|------|
| macOS Intel | `darwin-amd64` |
| macOS Apple Silicon | `darwin-arm64` |
| Linux x64 | `linux-amd64` |
| Linux ARM64 | `linux-arm64` |
| Windows x64 | `windows-amd64` |
| Windows ARM64 | `windows-arm64` |

## 开发命令

### 初始化新包

```bash
cursortoolset init <包名>
```

### 打包（唯一标准方式）

```bash
# 打包并计算 SHA256
cursortoolset pack

# 验证打包结果
cursortoolset pack --verify
```

> **重要**：始终使用 `cursortoolset pack`，不要手动执行 tar 打包。

## 发布流程（唯一推荐方式）

### 使用 cursortoolset release 命令

#### 推荐方式：使用 --wait 选项

```bash
# 发布 patch 版本并等待 CI 完成
cursortoolset release --wait

# 发布 minor 版本并等待
cursortoolset release --minor --wait

# 发布 major 版本并等待
cursortoolset release --major --wait
```

#### release 命令选项

| 选项 | 说明 |
|------|------|
| `--major` | 发布主版本 (x.0.0) |
| `--minor` | 发布次版本 (0.x.0) |
| `--patch` | 发布补丁版本 (0.0.x)，默认 |
| `--wait` | 等待 GitHub Actions 完成并确认 Release 创建 |
| `--dry-run` | 预览模式，不执行实际操作 |
| `--skip-tag` | 跳过 Git tag 和 push |

#### --wait 功能说明

- 推送 tag 后自动轮询 GitHub Actions 状态
- 使用 `gh` CLI 查询 API（避免限流）
- Workflow 完成后自动检查 Release 是否创建成功
- 超时时间：30 分钟
- **前置条件**：需要安装并认证 `gh` CLI (`gh auth login`)

#### 基本用法（不使用 --wait）

```bash
# 发布 patch 版本 (0.0.x) - 默认
cursortoolset release

# 发布 minor 版本 (0.x.0)
cursortoolset release --minor

# 发布 major 版本 (x.0.0)
cursortoolset release --major

# 预览发布流程（不执行）
cursortoolset release --dry-run
```

**命令自动完成：**

1. ✅ 提升 `package.json` 中的版本号
2. ✅ 打包 tarball（包含正确版本的 package.json）
3. ✅ 计算 SHA256 并更新 `package.json`
4. ✅ Git commit
5. ✅ 创建 Git tag
6. ✅ 推送到远程仓库

> **提示**：
> - **推荐使用 `--wait` 选项**：在自动化发布流程中，使用 `--wait` 可以避免频繁调用 GitHub API 导致限流问题
> - 使用 `--dry-run` 先预览，确认无误后再正式发布

### 发布后自动流程

推送 tag 后，GitHub Actions 会自动：

1. 创建 Release 并上传文件
2. **首次发布**：自动创建 `[auto-register]` Issue，触发注册到 CursorToolset
3. **后续发布**：自动创建带有 `pack-sync` label 的 `[sync]` Issue，触发版本同步

> **重要（v1.7.3+）**：后续发布时，必须使用 `pack-sync` label 创建 sync issue，这是 CursorToolset 识别和处理 sync issue 的标准方式。Release workflow 模板已更新为使用 `gh` CLI 自动添加此 label。

## 注册与同步机制

### 首次发布 - 自动注册

首次发布时，GitHub Actions 会自动创建 `[auto-register]` Issue 到 CursorToolset 仓库：

1. CI 验证包的有效性（仓库结构、版本信息等）
2. 验证通过后，自动添加到 `registry.json`
3. 注册表更新后发布到 `registry` Release

### 后续发布 - 自动同步

后续发布时，GitHub Actions 会自动创建带有 `pack-sync` label 的 sync Issue：

1. **使用 `pack-sync` label 识别**：CursorToolset 通过 `pack-sync` label 识别 sync issue（更可靠，不依赖 title 解析）
2. **支持 Payload 文件读取**：如果使用 `github-issue` 工具创建 issue，CursorToolset 会优先从 Gist payload 读取同步信息
3. **自动触发同步**：Issue 创建后，CursorToolset 的 sync workflow 会自动处理并同步版本信息
4. **定时同步**：也可等待定时同步（每小时一次）

### Sync Issue 处理机制（v1.7.3+）

CursorToolset v1.7.3 改进了包发布后自动同步机制：

1. **使用 `pack-sync` label 识别**：从依赖 title 解析改为使用 `pack-sync` label 识别 sync issue，更可靠
2. **支持 Payload 文件读取**：优先从 Gist payload 读取同步信息（如果使用 `github-issue` 工具创建），避免解析问题
3. **完全自动化**：Release workflow 自动创建 sync issue，无需手动操作

**重要**：确保 Release workflow 中创建 issue 时添加 `pack-sync` label，这是 CursorToolset 识别 sync issue 的标准方式。

### 手动注册（维护者使用）

```bash
# 添加包到注册表
cursortoolset registry add https://github.com/user/repo

# 移除包
cursortoolset registry remove package-name

# 导出注册表
cursortoolset registry export > registry.json
```

## GitHub Actions 工作流

### 自动发布工作流模板

```yaml
name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
    
    steps:
      - uses: actions/checkout@v4
      
      # 构建步骤（根据项目类型调整）
      - name: Build
        run: make build
      
      # 打包
      - name: Create tarball
        run: |
          PACKAGE_NAME=$(jq -r '.name' package.json)
          VERSION=${GITHUB_REF#refs/tags/v}
          mkdir -p /tmp/release
          tar -czvf /tmp/release/${PACKAGE_NAME}-${VERSION}.tar.gz \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='*.go' \
            --exclude='go.mod' \
            --exclude='go.sum' \
            .
      
      # 计算 SHA256 并生成 release package.json
      - name: Generate release package.json
        run: |
          PACKAGE_NAME=$(jq -r '.name' package.json)
          VERSION=${GITHUB_REF#refs/tags/v}
          TARBALL="${PACKAGE_NAME}-${VERSION}.tar.gz"
          SHA256=$(sha256sum /tmp/release/$TARBALL | cut -d' ' -f1)
          
          jq --arg sha256 "$SHA256" --arg version "$VERSION" \
             '.version = $version | .dist.sha256 = $sha256' \
             package.json > /tmp/release/package.json
      
      # 创建 Release
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            /tmp/release/package.json
            /tmp/release/*.tar.gz
          generate_release_notes: true
      
      # 触发注册表同步（创建 sync issue，使用 pack-sync label）
      - name: Trigger Registry Sync
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 使用 gh CLI 创建 issue，自动添加 pack-sync label
          # 这是 CursorToolset v1.7.3+ 的标准方式
          gh issue create \
            --repo shichao402/CursorToolset \
            --title "[sync] ${{ github.repository }} v${{ github.ref_name }}" \
            --body "Package: ${{ github.repository }}
          Version: ${{ github.ref_name }}
          Release: ${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ github.ref_name }}" \
            --label "pack-sync"
```

## 常见问题

### Q: 每次 `cursortoolset update` 都重复安装同一个包

**原因**：tarball 内的 `package.json` 版本号与 release 版本不一致。

**解决**：使用 `cursortoolset release` 重新发布，它会自动保证版本一致性。

### Q: tarball 打包时出现 "file changed as we read it"

**原因**：tar 输出在当前目录，打包时包含了自己。

**解决**：输出到 `/tmp/release/` 或其他目录。

### Q: 排除规则把构建产物也排除了

**原因**：使用了 `--exclude='core/tools'` 这样的目录排除。

**解决**：精确排除源码文件：

```bash
--exclude='*.go' \
--exclude='go.mod' \
--exclude='go.sum'
```

### Q: 安装后 bin 命令找不到

**检查**：
1. `bin` 配置的路径是否正确
2. 平台标识是否匹配当前系统
3. 文件是否有执行权限

### Q: 包注册后在 registry 中找不到

**原因**：`[auto-register]` Issue 可能未被处理或验证失败。

**解决**：
1. 检查 CursorToolset 仓库的 Issues
2. 确认包结构符合规范
3. 手动联系维护者或重新发布

### Q: 发布后未自动创建 sync issue 或注册表未同步

**原因（v1.7.3+）**：
1. Release workflow 中未正确创建 sync issue 或未添加 `pack-sync` label
2. CursorToolset 无法识别 sync issue（缺少 `pack-sync` label）

**解决**：
1. 检查 Release workflow 是否正确创建 sync issue 并添加 `pack-sync` label
2. 确保使用 `gh` CLI 创建 issue（推荐方式）
3. 检查 CursorToolset 仓库的 sync workflow 是否正常运行
4. 确认 sync issue 是否带有 `pack-sync` label

**重要**：从 v1.7.3 开始，CursorToolset 使用 `pack-sync` label 识别 sync issue，不再依赖 title 解析。确保 Release workflow 模板已更新。

## 禁止行为

- ❌ 手动执行 tar 打包（使用 `cursortoolset pack`）
- ❌ 手动修改版本号后发布（使用 `cursortoolset release`）
- ❌ 发布时不包含 SHA256 校验和
- ❌ 使用绝对路径声明可执行文件
- ❌ 跳过版本号更新直接发布
- ❌ 不在 `package.json` 中声明版本

## 必须遵守

- ✅ 使用 `cursortoolset release` 发布（唯一推荐方式）
- ✅ 使用 `cursortoolset pack` 打包
- ✅ 使用语义化版本号
- ✅ 发布包必须包含 SHA256 校验和
- ✅ 可执行文件必须在 `bin` 字段声明
- ✅ 配置 GitHub Actions 自动化发布和注册
- ✅ 发布前使用 `--dry-run` 预览

## 包管理命令参考

```bash
# 更新包索引
cursortoolset registry update

# 搜索包
cursortoolset search <关键词>

# 安装包
cursortoolset install <包名>

# 查看包信息
cursortoolset info <包名>

# 卸载包
cursortoolset uninstall <包名>

# 更新所有已安装的包
cursortoolset update

# 更新管理器自身
cursortoolset update --self
```

## 本地开发环境

### 安装 CursorToolset

```bash
# Linux / macOS
curl -fsSL https://raw.githubusercontent.com/shichao402/CursorToolset/ReleaseLatest/scripts/install.sh | bash

# 添加到 PATH
echo 'export PATH="$HOME/.cursortoolsets/bin:$PATH"' >> ~/.bashrc
source ~/.bashrc
```

### 目录结构

```
~/.cursortoolsets/
├── repos/           # 已安装的包
├── cache/           # 下载缓存
├── config/          # 配置文件
└── bin/             # 可执行文件符号链接
```
