---
alwaysApply: true
---
# {{ MODULE_NAME }}更新模块规则

## 模块信息

- **模块名称：** {{ MODULE_NAME }}
- **模块路径：** {{ MODULE_PATH }}
- **应用项目：** {{ PROJECT_NAME }}

## 核心约束（强制）

1. **更新模块必须实现统一的更新接口**
2. **更新流程必须可中断和可恢复**
3. **更新过程必须记录详细日志**
4. **更新失败必须提供回滚机制**

## 更新接口设计

### 统一更新接口

```pseudocode
UpdateManager:
  - checkUpdate()      // 检查更新，返回 UpdateResult
  - downloadUpdate()   // 下载更新，返回 UpdateResult
  - installUpdate()    // 安装更新，返回 UpdateResult
  - applyUpdate()      // 应用更新，返回 UpdateResult
  - rollback()         // 回滚到上一版本
```

### 使用示例（伪代码）

```pseudocode
// ✅ 正确：使用统一更新管理器
manager = UpdateManager.getInstance()
result = manager.checkUpdate()
IF result.hasUpdate:
    manager.downloadUpdate()
    manager.installUpdate()
    manager.applyUpdate()

// ❌ 错误：分散的更新逻辑
checkUpdate()
downloadFile(url)
installManually()
```

## 更新流程

### 标准流程

```
检查更新
    ↓
发现新版本？ ─否→ 结束
    ↓是
下载更新包
    ↓
验证完整性
    ↓
备份当前版本
    ↓
安装更新
    ↓
验证安装 ─失败→ 回滚
    ↓成功
应用更新
    ↓
清理临时文件
```

### 错误处理

| 错误类型 | 处理方式 |
|---------|---------|
| 网络错误 | 记录日志，支持重试 |
| 下载失败 | 支持断点续传 |
| 安装失败 | 自动回滚到上一版本 |
| 验证失败 | 拒绝应用，保持当前版本 |

## 日志记录

更新过程必须记录详细日志：

```pseudocode
// 检查更新
logger.log("开始检查更新", "UPDATE")
logger.log("更新服务器: " + updateUrl, "UPDATE")

// 发现更新
logger.log("发现新版本: " + newVersion, "UPDATE")

// 下载进度
logger.log("下载进度: " + progress + "%", "UPDATE_DOWNLOAD")

// 错误处理
logger.logError("更新失败", error, "UPDATE")
```

### 日志标签

| 标签 | 用途 |
|------|------|
| `UPDATE` | 更新流程日志 |
| `UPDATE_CHECK` | 更新检查日志 |
| `UPDATE_DOWNLOAD` | 更新下载日志 |
| `UPDATE_INSTALL` | 更新安装日志 |
| `UPDATE_ROLLBACK` | 更新回滚日志 |

## 禁止行为

- ❌ 不记录更新日志
- ❌ 不支持更新中断和恢复
- ❌ 不提供回滚机制
- ❌ 不验证更新包完整性
- ❌ 不备份当前版本

## 必须遵守

- ✅ 实现统一的更新接口
- ✅ 支持更新流程中断和恢复
- ✅ 记录详细的更新日志
- ✅ 提供回滚机制
- ✅ 验证更新包完整性（SHA256）
- ✅ 备份当前版本
- ✅ 使用项目统一的日志服务
