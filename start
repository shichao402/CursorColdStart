#!/bin/bash

# 项目初始化系统启动脚本（Mac/Linux）
# 使用 pipenv 自动管理虚拟环境，无需手动激活

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
START_PY="$SCRIPT_DIR/coldstart.py"
PIPFILE="$SCRIPT_DIR/Pipfile"

# 检查 Pipfile 是否存在
if [ ! -f "$PIPFILE" ]; then
    echo "❌ 错误：找不到 Pipfile: $PIPFILE"
    echo ""
    echo "请先运行安装脚本："
    echo "  python install.py"
    echo "  或"
    echo "  ./install.sh"
    exit 1
fi

# 检查 pipenv 是否安装
if ! command -v pipenv &> /dev/null; then
    echo "❌ 错误：pipenv 未安装"
    echo ""
    echo "请先安装 pipenv："
    echo "  pip3 install --user pipenv"
    echo ""
    echo "如果 pipenv 命令不可用，请将 ~/.local/bin 添加到 PATH"
    exit 1
fi

# 检查虚拟环境是否存在，如果不存在则创建
if ! pipenv --venv &> /dev/null; then
    echo "⚠️  虚拟环境不存在，正在创建..."
    cd "$SCRIPT_DIR"
    pipenv install
fi

# 检查 coldstart.py 是否存在
if [ ! -f "$START_PY" ]; then
    echo "❌ 错误：找不到 coldstart.py: $START_PY"
    exit 1
fi

# 使用 pipenv 运行 coldstart.py，并传递所有参数
cd "$SCRIPT_DIR"
exec pipenv run python "$START_PY" "$@"
